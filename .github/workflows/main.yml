name: CI
on:
  push:
    branches:
      - main
      - alpha
      - beta
      - next
  pull_request:

env:
  NX_CLOUD_ACCESS_TOKEN: ${{secrets.NX_CLOUD_ACCESS_TOKEN}}

jobs:
  lint_workspace:
    name: Lint Workspace
    runs-on: ubuntu-latest
    steps:
      # consider creating reusable action for this
      - uses: actions/checkout@v2
        name: Checkout [Trunk]
        if: ${{ github.event_name != 'pull_request' }}
        with:
          fetch-depth: 0
      - uses: actions/checkout@v2
        name: Checkout [PR]
        if: ${{ github.event_name == 'pull_request' }}
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npx nx workspace-lint
  stage_1:
    name: Stage 1
    needs: lint_workspace
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task:
          - lint
          - test
          - build
          # - e2e
    steps:
      # consider creating reusable action for this
      - uses: actions/checkout@v2
        name: Checkout [main]
        if: ${{ github.event_name != 'pull_request' }}
        with:
          fetch-depth: 0
      - uses: actions/checkout@v2
        name: Checkout [PR]
        if: ${{ github.event_name == 'pull_request' }}
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '16'
          cache: npm
      - run: npm ci --ignore-scripts
      - name: ${{ matrix.task }}
        run: npx nx affected --target=${{ matrix.task }} --parallel=3
  stage_2:
    name: Stage 2
    needs: stage_1
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task:
          - docker-build
    steps:
      # consider creating reusable action for this
      - uses: actions/checkout@v2
        name: Checkout [main]
        if: ${{ github.event_name != 'pull_request' }}
        with:
          fetch-depth: 0
      - uses: actions/checkout@v2
        name: Checkout [PR]
        if: ${{ github.event_name == 'pull_request' }}
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '16'
          cache: npm
      - run: npm ci --ignore-scripts
      - name: ${{ matrix.task }}
        run: npx nx affected --target=${{ matrix.task }} --parallel=3
  # do we need to do this in the same job that builds the docker image
  release:
    name: Release
    needs: stage_2
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task:
          - release
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOCKER_USERNAME: ${{secrets.DOCKER_USERNAME}}
      DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
    steps:
      # consider creating reusable action for this
      - uses: actions/checkout@v2
        name: Checkout [main]
        if: ${{ github.event_name != 'pull_request' }}
        with:
          fetch-depth: 0
      - uses: actions/checkout@v2
        name: Checkout [PR]
        if: ${{ github.event_name == 'pull_request' }}
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '16'
          cache: npm
      - run: npm ci --ignore-scripts
      - name: ${{ matrix.task }}
        run: npx nx affected --target=${{ matrix.task }} --parallel=1
